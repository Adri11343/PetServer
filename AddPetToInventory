--[[
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ADD PET TO INVENTORY + PET INDEX INTEGRATION
  ServerScriptService â†’ PetServer â†’ AddPetToInventory
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--]]
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- âœ… NO REQUERIR NADA MÃS AQUÃ PARA EVITAR RECURSIÃ“N
local pets = ReplicatedStorage:WaitForChild("Pets")
local configModule = ReplicatedStorage:WaitForChild("CONFIGURATION")

--------------------------------------------------------------------------------
--// FUNCIÃ“N PARA BUSCAR PET
--------------------------------------------------------------------------------
local function findPetTemplate(petName, rarityName)
	-- ValidaciÃ³n temprana
	if not petName or petName == "" then
		return nil
	end
	-- Si se especifica rareza, buscar en esa carpeta
	if rarityName and rarityName ~= "" then
		local rarityFolder = pets:FindFirstChild(rarityName)
		if rarityFolder then
			local pet = rarityFolder:FindFirstChild(petName)
			if pet then 
				return pet 
			end
		end
	end
	-- BÃºsqueda recursiva en todas las carpetas
	return pets:FindFirstChild(petName, true)
end

--------------------------------------------------------------------------------
--// FUNCIÃ“N PRINCIPAL
--------------------------------------------------------------------------------
local function addPet(player, petName, rarityName)
	-- âœ… REQUERIR CONFIG SOLO CUANDO SE NECESITE (evita recursiÃ³n)
	local Config = require(configModule)

	-- âœ… VALIDACIÃ“N MEJORADA: Verificar player
	if not player or not player.Parent then
		warn("[AddPet] âŒ Player invÃ¡lido o desconectado")
		return false
	end

	-- âœ… VALIDACIÃ“N MEJORADA: Verificar petName
	if not petName or type(petName) ~= "string" or petName == "" then
		warn("[AddPet] âŒ Nombre de pet invÃ¡lido:", petName, "| Player:", player.Name)
		return false
	end

	-- Verificar carpeta de inventario
	local petsInventory = player:FindFirstChild("PetsInventory")
	if not petsInventory then
		warn("[AddPet] âŒ Player no tiene PetsInventory:", player.Name)
		return false
	end

	-- Verificar lÃ­mite de inventario
	if #petsInventory:GetChildren() >= Config.MaxPetsInventory then
		warn("[AddPet] âš ï¸ Inventario lleno de", player.Name)
		return false
	end

	-- Buscar el template de la pet
	local petTemplate = findPetTemplate(petName, rarityName)
	if not petTemplate then
		warn("[AddPet] âŒ Pet no encontrada:", petName, "| Rareza:", rarityName or "cualquier rareza")
		return false
	end

	-- âœ… VALIDACIÃ“N ADICIONAL: Verificar que el template sea un Model
	if not petTemplate:IsA("Model") then
		warn("[AddPet] âŒ El template encontrado no es un Model:", petTemplate.ClassName)
		return false
	end

	-- âœ… OBTENER RAREZA SI NO SE PROPORCIONÃ“
	if not rarityName or rarityName == "" then
		rarityName = petTemplate.Parent and petTemplate.Parent.Name or "Unknown"
	end

	-- Crear ObjectValue en el inventario
	local petValue = Instance.new("ObjectValue")
	petValue.Name = petTemplate.Name
	petValue.Value = petTemplate
	petValue.Parent = petsInventory

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- âœ… INTEGRACIÃ“N CON PET INDEX
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	task.spawn(function()
		-- Cargar PetIndex de forma segura (evita recursiÃ³n)
		local PetIndex = _G.PetIndex

		if not PetIndex then
			-- Intentar cargar si no estÃ¡ en _G
			local success, module = pcall(function()
				return require(ServerStorage.Server:WaitForChild("pet_index_server", 3))
			end)

			if success then
				PetIndex = module
			end
		end

		-- Registrar en el Index si estÃ¡ disponible
		if PetIndex and PetIndex.UnlockPet then
			local indexSuccess = PetIndex.UnlockPet(player, petName, rarityName)

			if indexSuccess then
				print("ğŸ“– [PetIndex]", player.Name, "registrÃ³:", petName, "(" .. rarityName .. ")")
			elseif indexSuccess == false then
				-- Ya estÃ¡ registrado o error menor, no es crÃ­tico
				if Config.DebugMode then
					print("â„¹ï¸ [PetIndex]", petName, "ya estaba en el Ã­ndice de", player.Name)
				end
			end
		else
			if Config.DebugMode then
				warn("âš ï¸ [PetIndex] No disponible, pet no se registrÃ³ en el Ã­ndice")
			end
		end
	end)
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

	if Config.DebugMode then
		print("[AddPet] âœ…", petName, "agregada al inventario de", player.Name)
	end

	return true
end

--------------------------------------------------------------------------------
-- âœ… RETORNAR LA FUNCIÃ“N DIRECTAMENTE
return addPet
